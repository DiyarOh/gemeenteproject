{% extends 'base.html' %}

{% block title %}Klachtformulier{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<!-- Include jQuery -->
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<!-- Include SweetAlert2 CSS and JS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@10/dist/sweetalert2.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10/dist/sweetalert2.min.js"></script>
<style>
    #map {
        height: 480px;
        width: 735px;
        float: left;
    }

    #form-container {
        margin-left: 750px;
    }

    .form-field {
        margin-bottom: 10px;
    }

    label {
        display: block;
        margin-bottom: 5px;
    }

    input,
    textarea,
    select {
        width: calc(100% - 12px);
        padding: 5px;
        box-sizing: border-box;
    }

    button {
        margin-top: 10px;
    }
</style>
{% endblock %}
{% block content %}
<body>
    <!-- Leaflet Map Container -->
    <div id="map"></div>

    <!-- Form Container -->
    <div id="form-container">
        <script>
            window.onload = function() {
                {% if message %}
                    Swal.fire({
                        title: 'Success!',
                        text: '{{ message }}',
                        icon: 'success',
                        confirmButtonText: 'OK'
                    });
                {% endif %}
                {% if error %}
                    Swal.fire({
                        title: 'Error!',
                        text: '{{ error }}',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                {% endif %}
            };
        </script>
        <!-- Klacht Submission Form -->
        <form enctype="multipart/form-data" id="gpsForm" method="post">
            {% csrf_token %}
            {{ form.as_p }}
            <div class="form-field">
                <button type="submit" id="submit-button" disabled>Submit</button>
            </div>
        </form>
    </div>

{% endblock %}
{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10/dist/sweetalert2.all.min.js"></script>

    <!-- JavaScript for Leaflet Map and Form Submission -->
    <script>
        // Initialize Leaflet map
        let map = L.map('map').setView([51.9225, 4.47917], 13);

        // Add OpenStreetMap tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        // Initialize variables for marker and coordinates input
        let marker;
        let longitudeInput = document.getElementById('longitude');
        let latitudeInput = document.getElementById('latitude');
        let submitButton = document.getElementById('submit-button');

        // Add click event listener to update marker and coordinates on map click
        map.on('click', function (e) {
            if (marker) {
                map.removeLayer(marker);
            }

            marker = L.marker(e.latlng).addTo(map);

        longitudeInput.value = e.latlng.lng;
        latitudeInput.value = e.latlng.lat;
        
        // Enable the submit button
        submitButton.disabled = false;

        });

        // Add event listener for form submission
        // $('#gpsForm').submit(function (event) {
        //     // Prevent the default form submission
        //     event.preventDefault();

        //     // Get form data
        //     let formData = $(this).serializeArray();

        //     // Add latitude and longitude to the formData array
        //     formData.push({ name: 'latitude', value: marker.getLatLng().lat });
        //     formData.push({ name: 'longitude', value: marker.getLatLng().lng });

        //     // Make an AJAX request to your Django view
        //     $.ajax({
        //         type: 'POST',
        //         url: '{% url "submit_klacht" %}',
        //         data: formData,
        //         headers: {
        //             'X-CSRFToken': $('input[name=csrfmiddlewaretoken]').val()
        //         },
        //         success: function (response) {
        //             // Display a success popup
        //             Swal.fire({
        //                 title: 'Success!',
        //                 text: 'Klacht submitted successfully!',
        //                 icon: 'success',
        //                 confirmButtonText: 'OK'
        //             }).then((result) => {
        //                 // Redirect to a different HTML page after clicking "OK"
        //                 if (result.isConfirmed) {
        //                     window.location.href = '{% url "complaints_dashboard" %}';
        //                 }
        //             });
        //         },
        //         error: function (error) {
        //             // Display an error popup
        //             Swal.fire({
        //                 title: 'Error!',
        //                 text: 'Error submitting klacht!',
        //                 icon: 'error',
        //                 confirmButtonText: 'OK'
        //             });
        //             // Handle error, if needed
        //         }
        //     });
        // });
    </script>
{% endblock %}
